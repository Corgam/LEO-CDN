version: "3.7"
services:
  {{ node_name }}:
    build: ../FReD
    depends_on:
      - {{ store_name }}
    image: fred/fred:local
    container_name: {{ node_name }}
    entrypoint: "fred \
    --remote-storage-host {{ store_IP }}:1337 \
    --peer-host {{ node_IP }}:5555 \
    --nodeID {{ node_name }} \
    --host {{ node_IP }}:9001 \
    --cert /cert/{{ node_name }}.crt \
    --key /cert/{{ node_name }}.key \
    --ca-file /cert/ca.crt \
    --adaptor remote \
    --nase-host {{ nase_host }} \
    --nase-cert /cert/{{ node_name }}.crt \
    --nase-key /cert/{{ node_name }}.key \
    --nase-ca /cert/ca.crt \
    --handler dev \
    --badgerdb-path ./db \
    --remote-storage-cert /cert/{{ node_name }}.crt \
    --remote-storage-key /cert/{{ node_name }}.key  \
    --trigger-cert /cert/{{ node_name }}.crt \
    --trigger-key /cert/{{ node_name }}.key"
    environment:
      - LOG_LEVEL
    volumes:
      - ../temp/{{ node_name }}.crt:/cert/{{ node_name }}.crt
      - ../temp/{{ node_name }}.key:/cert/{{ node_name }}.key
      - ../cert/ca.crt:/cert/ca.crt
    ports:
      - {{ host_port }}:9001
    networks:
      fredwork:
        ipv4_address: {{ node_IP }}

  {{ store_name }}:
    build:
      context: ../FReD
      dockerfile: storage.Dockerfile
    image: fred/store:local
    container_name: {{ store_name }}
    entrypoint: "storageserver \
    --log-level '${LOG_LEVEL_STORE}' \
    --cert /cert/cert.crt \
    --key /cert/key.key \
    --ca-file /cert/ca.crt"
    volumes:
      - ../temp/{{ store_name }}.crt:/cert/cert.crt
      - ../temp/{{ store_name }}.key:/cert/key.key
      - ../cert/ca.crt:/cert/ca.crt
    networks:
      fredwork:
        ipv4_address: {{ store_IP }}

  {{ server_name }}:
    build:
      context: ../
      dockerfile: httpserver.Dockerfile
    depends_on:
    - {{ node_name }}
    image: httpserver:local
    container_name: {{ server_name }}
    volumes:
      - ../temp/{{ server_name }}.crt:/cert/client.crt
      - ../temp/{{ server_name }}.key:/cert/client.key
      - ../cert/ca.crt:/cert/ca.crt
      - ../proto:/proto
      - ../temp/nodes.json:/info/nodes.json
      - ../temp/{{ server_name }}.json:/info/node.json
      - ../satellite_server.py:/satellite_server.py
    networks:
      fredwork:
        ipv4_address: {{ server_IP }}

networks:
  fredwork:
    external: true
